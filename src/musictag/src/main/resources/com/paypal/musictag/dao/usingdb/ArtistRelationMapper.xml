<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.paypal.musictag.dao.usingdb.ArtistRelationMapper">
	<select id="findArtistCreditLinkWithCount" resultType="map">

	with first_level as (
		select ar1.id as source, ar2.id as target, sum(ac1.ref_count) as count
		from artist_credit_name as acn1 
			join artist as ar1 on acn1.artist = ar1.id
			join artist_credit as ac1 on acn1.artist_credit = ac1.id
			join artist_credit_name as acn2 on acn2.artist_credit = acn1.artist_credit 
			join artist as ar2 on ar2.id = acn2.artist
		where ar1.gid =#{artistGid, typeHandler=com.paypal.musictag.util.UuidTypeHandler, javaType=java.util.UUID, jdbcType=VARCHAR} and ar2.gid != #{artistGid, typeHandler=com.paypal.musictag.util.UuidTypeHandler, javaType=java.util.UUID, jdbcType=VARCHAR}
		group by source, target
		order by count desc
		limit 10)
	
	select * from first_level;
	
	<!-- get second level relationship -->
<!-- 	union
	(select fl.target as source, acn2.artist as target,sum(ac1.ref_count) as count
	from artist_credit_name as acn1
		join first_level as fl on fl.target = acn1.artist
		join artist as ar1 on ar1.id = acn1.artist
		join artist_credit as ac1 on acn1.artist_credit = ac1.id
		join artist_credit_name as acn2 on acn2.artist_credit = acn1.artist_credit
		join artist as ar2 on ar2.id = acn2.artist
	where fl.target != acn2.artist and ar2.gid !=#{artistGid, typeHandler=com.paypal.musictag.util.UuidTypeHandler, javaType=java.util.UUID, jdbcType=VARCHAR}
	group by fl.target, acn2.artist
	order by count desc
	limit 30);
 -->	
	</select>
	
	<select id="findArtistCreditNode" resultType="map">
		select id, gid, name 
		from artist
		where id in
		<foreach item="artistId" collection='artistIds' open="(" separator="," close=")">
			#{artistId}
		</foreach>
	</select>
	
	<select id="getCooperationsOnRecordingOfArtists" resultType="map">
		with artist_credit_ids as (select distinct acn1.artist_credit
		from artist_credit_name acn1
		join artist_credit_name acn2 on acn1.artist_credit = acn2.artist_credit
		where acn1.artist = #{sid} and acn2.artist = #{tid})
		select  rcd.gid, rcd.name, rcd.length
		from recording as rcd
		where rcd.artist_credit in (select artist_credit from artist_credit_ids)
			and rcd.gid not in (select gid from recording_gid_redirect)
	</select>
	
	<select id="getCooperationsOnReleaseOfArtists" resultType="map">
		with artist_credit_ids as (select distinct acn1.artist_credit
		from artist_credit_name acn1
		join artist_credit_name acn2 on acn1.artist_credit = acn2.artist_credit
		where acn1.artist = #{sid} and acn2.artist = #{tid})
		select rls.gid, rls.name, area.name as country, rc.date_year, rc.date_month, rc.date_day
		from release as rls
			join release_country as rc on rls.id = rc.release
			join country_area as ca on rc.country = ca.area
			join area on ca.area = area.id
		where rls.artist_credit in (select artist_credit from artist_credit_ids)
			and rls.gid not in (select gid from release_gid_redirect)
	</select>
	
	<select id="getArtistCountInFirstLevel" resultType="map">
		select count(distinct acn1.artist)
		from artist_credit_name as acn 
		join artist as ar on acn.artist = ar.id
		join artist_credit_name as acn1 on acn.artist_credit = acn1.artist_credit
		join artist as ar1 on ar1.id = acn1. artist
		where ar.gid = #{artistGid, typeHandler=com.paypal.musictag.util.UuidTypeHandler, javaType=java.util.UUID, jdbcType=VARCHAR}
			and ar1.gid != #{artistGid, typeHandler=com.paypal.musictag.util.UuidTypeHandler, javaType=java.util.UUID, jdbcType=VARCHAR}
	</select>

	<select id="getReleaseCount" resultType="int">
		SELECT count(*) AS release_count
		FROM release
			JOIN artist_credit_name acn ON release.artist_credit = acn.artist_credit
			JOIN artist on acn.artist = artist.id
		WHERE artist.gid = #{artistGid, typeHandler=com.paypal.musictag.util.UuidTypeHandler, javaType=java.util.UUID, jdbcType=VARCHAR}
	</select>

	<select id="getRecordingCount" resultType="int">
		SELECT count(*) AS recording_count
		FROM recording
			JOIN artist_credit_name acn ON recording.artist_credit = acn.artist_credit
			JOIN artist on acn.artist = artist.id
		WHERE artist.gid = #{artistGid, typeHandler=com.paypal.musictag.util.UuidTypeHandler, javaType=java.util.UUID, jdbcType=VARCHAR}
	</select>

	<select id="getReleaseYearlyDist" resultType="map">
		SELECT COALESCE(release_event.date_year, -1) as date_year, count(*) AS release_count, sum(medium.track_count) as recording_count
		FROM release
			JOIN artist_credit_name acn ON release.artist_credit = acn.artist_credit
			JOIN artist on acn.artist = artist.id
			JOIN medium on medium.release = release.id
			JOIN release_event on release_event.release = release.id
		WHERE artist.gid = #{artistGid, typeHandler=com.paypal.musictag.util.UuidTypeHandler, javaType=java.util.UUID, jdbcType=VARCHAR}
		group by release_event.date_year
        ORDER BY date_year
	</select>
	
	<select id="getArtistArea" resultType="map">
        select name from area where id in (select distinct rc.country from release
JOIN artist_credit_name acn ON release.artist_credit = acn.artist_credit
JOIN artist on acn.artist = artist.id
JOIN release_country rc ON release.id = rc.release
where artist.gid = #{artistGid, typeHandler=com.paypal.musictag.util.UuidTypeHandler, javaType=java.util.UUID, jdbcType=VARCHAR})
	</select>
</mapper>